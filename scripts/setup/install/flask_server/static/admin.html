<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Admin Dashboard</title>

    <!-- Bootstrap + Cyborg Theme -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootswatch@5.3.3/dist/cyborg/bootstrap.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet"/>

    <style>
        h1.text-info {
            color: #00bcd4 !important;
        }

        .card {
            background-color: #111 !important;
            border: 1px solid #444 !important;
            transition: box-shadow 0.3s ease-in-out, border-color 0.3s ease-in-out;
        }

        .card:not(.refreshing):not(.shutting-down):not(.disconnected) {
            border-color: #444 !important;
            box-shadow: none !important;
        }

        .card-header {
            background-color: #111 !important;
            border-bottom: 1px solid #444 !important;
            color: #ccc !important;
        }

        .card.refreshing {
            border-color: #00c17c !important;
            box-shadow: 0 0 8px 3px rgba(0, 193, 124, 0.4) !important;
        }

        .card.shutting-down {
            border-color: #ffa500 !important;
            box-shadow: 0 0 12px 5px rgba(255, 165, 0, 0.7) !important;
        }

        .card.disconnected {
            border-color: #ffa500 !important;
            box-shadow: 0 0 10px 4px rgba(255, 165, 0, 0.6) !important;
        }

        #status-offline-msg {
            font-weight: bold;
        }

        #status-refresh-label.glow-text {
            color: #00ff90 !important;
            transition: color 0.5s ease-in-out;
        }

        .log-output, pre, .status-output {
            background-color: #000 !important;
            color: #ccc !important;
            padding: 1rem;
            border-radius: 0.5rem;
            white-space: pre-wrap;
            font-family: monospace;
            height: 250px;
            overflow-y: auto;
        }

        #shutdown-confirm {
            margin-top: 0.75rem;
            font-size: 0.875rem;
            color: #ffa500;
        }
    </style>
</head>
<body class="py-4">
<div class="container">
    <h1 class="text-info fw-bold text-center mb-5">
        <i class="bi bi-speedometer2 me-2"></i> Admin Dashboard
    </h1>

    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card text-light shadow-sm border-warning" id="shutdown-card">
                <div class="card-header fw-bold">
                    <i class="bi bi-exclamation-triangle-fill text-warning me-2"></i> Graceful Shutdown
                </div>
                <div class="card-body text-center">
                    <p class="small text-muted mb-4">Safely save and stop the VRising server.</p>
                    <form id="shutdown-form">
                        <button class="btn btn-outline-warning" type="submit">
                            <i class="bi bi-power me-2"></i> Trigger Shutdown
                        </button>
                    </form>
                    <div id="shutdown-confirm"></div>
                </div>
            </div>
        </div>

        <div class="col-md-8">
            <div class="card text-light shadow-sm border-success" id="status-card">
                <div class="card-header fw-bold d-flex align-items-center justify-content-between">
                    <span><i class="bi bi-bar-chart-line me-2"></i> Server Status</span>
                    <span id="status-offline-msg" class="text-warning small d-none">Server Offline</span>
                </div>
                <div class="card-body">
                    <div id="status-output" class="status-output">Loading status...</div>
                    <small class="text-muted d-block mt-2" id="status-refresh-label">
                        Auto-refreshes every 5 seconds.
                    </small>
                </div>
            </div>
        </div>
    </div>

    <div class="card text-light shadow-sm border-secondary mb-3" id="log-card">
        <div class="card-header fw-bold d-flex align-items-center">
            <i class="bi bi-journal-text me-2"></i> Logs
        </div>
        <div class="card-body">
            <form class="mb-3" id="log-form">
                <label class="form-label" for="log-select">Select log file:</label>
                <select class="form-select" id="log-select">
                    <option value="VRisingServer.log">VRisingServer.log</option>
                    <option value="startup.log">startup.log</option>
                    <option value="shutdown.log">shutdown.log</option>
                    <option value="nginx/access">nginx access log</option>
                    <option value="nginx/error">nginx error log</option>
                    <option value="webhook">webhook server log</option>
                    <option value="systemd/shutdown">shutdown service log</option>
                </select>
            </form>
            <div class="log-output" id="log-output">Loading log...</div>
        </div>
    </div>

    <div class="text-end mt-4">
        <a class="text-info small text-decoration-none" href="/directory">
            <i class="bi bi-diagram-3 me-1"></i> View Full Site Directory
        </a>
    </div>
</div>

<script>
    const output = document.getElementById('log-output');
    const select = document.getElementById('log-select');
    const logCard = document.getElementById('log-card');
    const statusCard = document.getElementById('status-card');
    const statusOutput = document.getElementById('status-output');
    const shutdownForm = document.getElementById('shutdown-form');
    const shutdownCard = document.getElementById('shutdown-card');
    const shutdownConfirm = document.getElementById('shutdown-confirm');
    const refreshLabel = document.getElementById('status-refresh-label');
    const offlineMsg = document.getElementById('status-offline-msg');

    async function loadLog() {
        logCard.classList.add('refreshing');
        const val = select.value;
        const url = val.endsWith('.log') ? `/logs/tail/${val}` : `/logs/${val}`;
        try {
            const res = await fetch(url);
            const text = await res.text();
            output.textContent = text;
            output.scrollTop = output.scrollHeight;
        } catch (e) {
            output.textContent = `Failed to load ${val}: ${e}`;
        } finally {
            setTimeout(() => logCard.classList.remove('refreshing'), 1000);
        }
    }

    async function refreshStatus() {
        try {
            const res = await fetch('/check-status');
            const text = await res.text();
            statusOutput.textContent = text;
            statusOutput.scrollTop = statusOutput.scrollHeight;

            // Green flash
            statusCard.classList.add('refreshing');
            refreshLabel.classList.add('glow-text');
            setTimeout(() => {
                statusCard.classList.remove('refreshing');
                refreshLabel.classList.remove('glow-text');
            }, 1000);
        } catch (err) {
            statusOutput.textContent = '⚠️ Failed to fetch status';
            console.error("Status error:", err.message);
        }
    }

    async function checkHeartbeat() {
        try {
            const res = await fetch('/ping');
            if (!res.ok) throw new Error("Ping failed");
            [statusCard, shutdownCard, logCard].forEach(card => card.classList.remove('disconnected'));
            offlineMsg.classList.add('d-none');
        } catch (e) {
            [statusCard, shutdownCard, logCard].forEach(card => card.classList.add('disconnected'));
            offlineMsg.classList.remove('d-none');
        }
    }

    shutdownForm.addEventListener('submit', async (e) => {
        e.preventDefault();

        let pulseCount = 0;
        const maxPulses = 10;
        const interval = 300;

        const pulseInterval = setInterval(() => {
            shutdownCard.classList.toggle('shutting-down');
            pulseCount++;
            if (pulseCount >= maxPulses * 2) {
                clearInterval(pulseInterval);
                shutdownCard.classList.remove('shutting-down');
                shutdownConfirm.innerText = '';
            }
        }, interval);

        try {
            const res = await fetch('/trigger-shutdown', {method: 'POST'});
            const data = await res.json();

            if (!data.status) throw new Error("Missing 'status' in server response");

            shutdownConfirm.innerText = data.time
                ? `🟠 ${data.status} at ${data.time}`
                : `⚠️ ${data.status} (missing timestamp)`;

        } catch (err) {
            shutdownConfirm.innerText = `⚠️ Shutdown request failed: ${err.message}`;
        }
    });

    select.addEventListener('change', loadLog);
    window.addEventListener('load', () => {
        loadLog();
        refreshStatus();
        checkHeartbeat();
    });

    setInterval(loadLog, 5000);
    setInterval(refreshStatus, 5000);
    setInterval(checkHeartbeat, 5000);
</script>
</body>
</html>
